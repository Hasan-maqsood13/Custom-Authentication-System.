<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <title>Signup Page</title>

  <style>
    .invalid {
      color: red;
    }

    .spinner-border {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      vertical-align: text-bottom;
      border: 0.15em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border 0.75s linear infinite;
    }

    #signup-btn {
      position: relative;
    }

    #signup-spinner {
      position: absolute;
      top: 15px;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container">
    <div class="row justify-content-center align-items-center min-vh-100">
      <div class="col-md-6 col-lg-5">
        <div class="card shadow-lg rounded-4" style="margin-top: 50px; margin-bottom: 50px;">
          <div class="card-body p-4">
            <h3 class="text-center mb-4">Create an Account</h3>
            <form id="signupForm">
              {% csrf_token %}
              <!-- Username -->
              <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" name="username" id="username" placeholder="Enter username"
                  required>
                {% if errors.name %}
                <div class="text-danger mt-1">{{ errors.name }}</div>
                {% endif %}
              </div>

              <!-- Email -->
              <div class="mb-3">
                <label for="email" class="form-label">Email address</label>
                <input type="email" class="form-control" name="email" id="email" placeholder="name@example.com"
                  required>
                {% if errors.email %}
                <div class="text-danger mt-1">{{ errors.email }}</div>
                {% endif %}
              </div>

              <!-- Password -->
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" name="password" id="password" placeholder="Enter password"
                  required>
                {% if errors.password %}
                <div class="text-danger mt-1">{{ errors.password }}</div>
                {% endif %}
              </div>
              <div id="password-contain" class="p-3 bg-light mb-2 rounded">
                <h5 class="fs-13">Password must contain:</h5>
                <p id="pass-length" class="invalid fs-12 mb-2">Minimum <b>8 characters</b></p>
                <p id="pass-lower" class="invalid fs-12 mb-2">At <b>lowercase</b> letter (a-z)</p>
                <p id="pass-upper" class="invalid fs-12 mb-2">At least <b>uppercase</b> letter (A-Z)</p>
                <p id="pass-number" class="invalid fs-12 mb-0">A least <b>number</b> (0-9)</p>
                <p id="pass-special" class="invalid fs-12 mb-0">At least one <b>special
                    character</b>(!@#$...)</p>
              </div>

              <!-- Sign up button -->
              <div class="d-grid">
                <button type="submit" id="signup-btn" class="btn btn-primary btn-lg" name="register">
                  <span id="signup-spinner" class="spinner-border spinner-border-sm text-white d-none me-4" role="status"
                    aria-hidden="true"></span>
                  <span id="signup-text">Sign Up</span>
                </button>
              </div>
            </form>
            <p class="text-center mt-3 mb-0">
              Already have an account? <a href="{% url 'login' %}">Login here</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
    integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Sweet alert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Your existing password validation script here...
    document.addEventListener("DOMContentLoaded", function () {
      const passwordInput = document.getElementById("password");
      const container = document.getElementById("password-contain");
      const passLength = document.getElementById("pass-length");
      const passLower = document.getElementById("pass-lower");
      const passUpper = document.getElementById("pass-upper");
      const passNumber = document.getElementById("pass-number");
      const passSpecial = document.getElementById("pass-special");

      container.style.display = "none";

      passwordInput.addEventListener("focus", function () {
        container.style.display = "block";
      });

      passwordInput.addEventListener("input", function () {
        const val = passwordInput.value;

        // Regex for validation
        const hasLength = val.length >= 8;
        const hasLowercase = /[a-z]/.test(val);
        const hasUppercase = /[A-Z]/.test(val);
        const hasNumber = /\d/.test(val);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(val);

        // Update classes based on validation
        function updateClass(element, isValid) {
          if (isValid) {
            element.classList.remove("invalid");
            element.classList.add("text-success");
          } else {
            element.classList.add("invalid");
            element.classList.remove("text-success");
          }
        }

        updateClass(passLength, hasLength);
        updateClass(passLower, hasLowercase);
        updateClass(passUpper, hasUppercase);
        updateClass(passNumber, hasNumber);
        updateClass(passSpecial, hasSpecial);
      });

      passwordInput.addEventListener("blur", function () {
        // Keep the container visible if any validation rule is not met
        const val = passwordInput.value;
        if (val.length < 8 || !/[a-z]/.test(val) || !/[A-Z]/.test(val) || !/\d/.test(val) || !/[!@#$%^&*(),.?":{}|<>]/.test(val)) {
          // Do nothing, let it remain visible
        } else {
          container.style.display = "none";
        }
      });
    });
  </script>

  <script>
    // CSRF token setup for AJAX
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
      headers: { 'X-CSRFToken': csrftoken }
    });

    $(document).ready(function () {
      $('#signupForm').on('submit', function (e) {
        e.preventDefault();

        // Show spinner and hide text
        $('#signup-spinner').removeClass('d-none');
        $('#signup-text').text('Loading...').removeClass('invisible').addClass('ms-4');
        $('#signup-btn').prop('disabled', true); // Disable button to prevent multiple submissions

        let fromData = new FormData(this);

        $.ajax({
          type: 'POST',
          url: '{% url "signup" %}',
          data: $(this).serialize(),
          success: function (response) {

            $('#signup-spinner').addClass('d-none');
            $('#signup-text').removeClass('invisible');
            $('#signup-btn').prop('disabled', false);

            if (response.success) {
              Swal.fire({
                title: 'Account Created.',
                text: 'Please check your email to verify your account.',
                icon: 'success',
                showConfirmButton: true, // Show a button for user to click
                confirmButtonText: 'OK'
              }).then((result) => {
                if (result.isConfirmed) {
                  // Redirect to the next URL provided by the server
                  window.location.href = response.next_url;
                }
              });
            } else {
              $('#signup-text').text('Sign Up ').removeClass('invisible').addClass('ms-4');
               $('#signup-spinner').addClass('d-none');
              // Display new errors
              for (let field in response.errors) {
                let input = $(`[name="${field}"]`);
                input.addClass('is-invalid');
                input.after(`<div class="text-danger mt-1">${response.errors[field]}</div>`);
              }

              Swal.fire({
                icon: "error",
                title: "An Error Occured",
                text: "Please correct the form errors.",
              });
            }
          },
          error: function () {
            $('#signup-spinner').addClass('d-none');
            $('#signup-text').removeClass('invisible');
            $('#signup-btn').prop('disabled', false);
            Swal.fire({
              icon: "error",
              title: "An Error Occured",
              text: "Something went wrong! Please try again later.",
            });
          }
        });


      })
    })
  </script>

</body>

</html>