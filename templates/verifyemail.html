<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Verification</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .digit-input {
      width: 60px;
      height: 70px;
      font-size: 2rem;
      text-align: center;
      margin: 0 5px;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .form-control:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
  </style>
</head>

<body class="bg-light">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6 col-lg-5">
        <div class="card shadow-lg">
          <div class="card-body p-5 text-center">
            <h3 class="mb-3">Verify Your Email</h3>
            <p class="text-muted mb-4">
              We've sent a 4-digit verification code to <span id="email-display">{{ request.session.verification_email
                }}</span>.
              Please enter the code below to verify your account.
            </p>

            <!-- Verification Form -->
            <form id="verifyEmailForm">
              {% csrf_token %}
              <div class="d-flex justify-content-center mb-4">
                <input type="text" class="form-control digit-input" id="digit1" name="dijit1" maxlength="1" required
                  onkeyup="moveToNext(1, event)" autocomplete="off">
                <input type="text" class="form-control digit-input" id="digit2" name="dijit2" maxlength="1" required
                  onkeyup="moveToNext(2, event)" autocomplete="off">
                <input type="text" class="form-control digit-input" id="digit3" name="dijit3" maxlength="1" required
                  onkeyup="moveToNext(3, event)" autocomplete="off">
                <input type="text" class="form-control digit-input" id="digit4" name="dijit4" maxlength="1" required
                  onkeyup="moveToNext(4, event)" autocomplete="off">
              </div>

              <!-- Error Message -->
              <div id="error-message" class="alert alert-danger d-none mb-3"></div>

              <!-- Verify Button -->
              <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg" id="verify-btn">
                  Verify Email
                </button>
              </div>
            </form>

            <!-- Resend Code -->
            <p class="mt-3 mb-0">
              Didn't get the code? <a href="#" id="resend-link">Resend</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Move to next input field or previous on backspace
    function moveToNext(current, event) {
      const inputs = document.querySelectorAll('.digit-input');

      if (event.key === 'Backspace') {
        if (current > 1) {
          inputs[current - 2].focus();
        }
        return;
      }

      if (event.key >= '0' && event.key <= '9') {
        if (current < inputs.length) {
          inputs[current].focus();
        }
      }
    }

    // Auto-focus first input on page load
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('digit1').focus();
    });

    $(document).ready(function () {
      // Handle form submission
      $('#verifyEmailForm').on('submit', function (e) {
        e.preventDefault();

        // Hide any previous error
        $('#error-message').addClass('d-none');

        // Show loading state
        const verifyBtn = $('#verify-btn');
        verifyBtn.prop('disabled', true).html(
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying...'
        );

        // Submit via AJAX
        $.ajax({
          type: 'POST',
          url: "{% url 'verifyemail' %}",
          data: $(this).serialize(),
          success: function (response) {
            if (response.success) {
              // Show success message and redirect
              Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: response.message || 'Email verified successfully!',
                confirmButtonText: 'Continue'
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = response.redirect_url || '/myapp/';
                }
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: response.message,
              });
              verifyBtn.prop('disabled', false).html('Verify Email');
            }
          },
          error: function (xhr, status, error) {
            // Show error message
            $('#error-message').text('An error occurred. Please try again.').removeClass('d-none');
            verifyBtn.prop('disabled', false).html('Verify Email');
          }
        });
      });

      // Handle resend code
      $('#resend-link').on('click', function (e) {
        e.preventDefault();

        Swal.fire({
          title: 'Resend Code?',
          text: 'Send a new verification code to your email?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, resend it!',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading
            Swal.fire({
              title: 'Sending...',
              text: 'Please wait',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // Request new code
            $.post('{% url "resend_verification" %}', {
              csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function (response) {
              Swal.close();

              if (response.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Code Sent!',
                  text: 'A new verification code has been sent to your email.'
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: response.message || 'Failed to resend verification code.'
                });
              }
            }).fail(function () {
              Swal.close();
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to resend verification code. Please try again.'
              });
            });
          }
        });
      });
    });
  </script>
</body>

</html>